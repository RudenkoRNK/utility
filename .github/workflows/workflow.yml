name: Test workflow

on:
  push:
    branches: main
  pull_request:
    branches: main

env:
  BUILD_TYPE: Debug # Release, Debug, RelWithDebInfo, etc.
  BOOST_URL: https://boostorg.jfrog.io/artifactory/main/release/1.76.0/source/boost_1_76_0.tar.bz2
  BOOST_VERSION: boost_1_76_0

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Update
      run: sudo apt-get update
    - name: Cache gcc
      id: cache-gcc
      uses: actions/cache@v2.1.5
      with:
        path: |
          /usr/bin/cpp-11
          /usr/bin/g++-11
          /usr/bin/gcc-11
          /usr/bin/gcc-11-base
          /usr/bin/libasan6
          /usr/bin/libatomic1
          /usr/bin/libcc1-0
          /usr/bin/libgcc-11-dev
          /usr/bin/libgcc-s1
          /usr/bin/libgomp1
          /usr/bin/libitm1
          /usr/bin/liblsan0
          /usr/bin/libquadmath0
          /usr/bin/libstdc++-11-dev
          /usr/bin/libstdc++6
          /usr/bin/libtsan0
          /usr/bin/libubsan1
          /usr/bin/libgcc-11-dev
        key: ${{ runner.os }}-gcc
    - name: Cache boost
      id: cache-boost
      uses: actions/cache@v2.1.5
      with:
        # A list of files, directories, and wildcard patterns to cache and restore
        path: ${{github.workspace}}/${{env.BOOST_VERSION}}
        # An explicit key for restoring and saving the cache
        key: ${{ runner.os }}-boost
    - name: GCC
      #if: steps.cache-gcc.outputs.cache-hit != 'true'
      run: |
        sudo apt-get install gcc-11 g++-11
        echo AAAAAAAAAA $(which g++-11)
    - name: Boost
      if: steps.cache-boost.outputs.cache-hit != 'true'
      run: |
           wget --directory-prefix=${{github.workspace}} ${{env.BOOST_URL}} -q
           tar --bzip2 -xf ${{github.workspace}}/${{env.BOOST_VERSION}}.tar.bz2 --directory ${{github.workspace}}
    - name: Setup
      run: mkdir ${{github.workspace}}/build
    - name: Configure CMake
      env:
       CC:   gcc-11
       CXX:  g++-11
      run: >
           cmake 
           -B ${{github.workspace}}/build
           -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
           -DUTILITY_TEST=ON
           -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
           -DBOOST_ROOT=${{github.workspace}}/${{env.BOOST_VERSION}}
    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}} --parallel 8
    - name: Test
      working-directory: ${{github.workspace}}/build
      run: utility_test/UtilityTest
